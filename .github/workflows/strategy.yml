name: Tree tbb

on:
  push :
    paths:
        - '.github/workflows/strategy.yml'

env:
  DOCKER_BUILDKIT: 1
  DEBIAN_FRONTEND: noninteractive

jobs:

  stage1:
    runs-on: ubuntu-latest
    steps:
      - name: Build Fetch
        uses: mohsen7s/runner-prune-except-docker@main
        with:
          docker-username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker-password: ${{ secrets.DOCKERHUB_PASSWORD }}
          use-image-name: ubuntu:22.04
          step-image-name: mohsen7s/tbb:sc1
          run-command: |
            apt-get update
            apt install -y -qq wget git build-essential vim curl
            apt install -y -qq libyaml-libyaml-perl libtemplate-perl libdatetime-perl \
                               libio-handle-util-perl libio-all-perl \
                               libio-captureoutput-perl libjson-perl libpath-tiny-perl \
                               libstring-shellquote-perl libsort-versions-perl \
                               libdigest-sha-perl libdata-uuid-perl libdata-dump-perl \
                               libfile-copy-recursive-perl libfile-slurp-perl git \
                               uidmap
            rm -rf /var/lib/apt/lists/* 
            usermod --add-subuids 1000000-1099999 --add-subgids 1000000-1099999 root
            git config --global http.postBuffer 524288000
            git config --global https.postBuffer 524288000
            git config --global http.sslVerify false
            git config --global https.sslVerify false
            git config --global core.compression -1
            git clone https://gitlab.torproject.org/tpo/applications/tor-browser-build.git
            cd tor-browser-build
            make submodule-update
            cd rbm
            rm -fr container
            wget https://gitlab.torproject.org/tpo/applications/rbm/-/raw/cad40965ce1204936a0df71c405bf0393b534ef9/container
            chmod 777 container
            cd ..
            make fetch
            
  stage2:
    runs-on: ubuntu-latest
    needs: stage1
    strategy: 
      fail-fast: false
      matrix:
        include:          
          - name: windows
            target: torbrowser-windows-x86_64
            components: |
              mingw-w64
              clang
              
          - name: android
            target: torbrowser-android-armv7
            components: |
              android-toolchain
              clang
              
          - name: linux
            target: torbrowser-linux-x86_64
            components: |
              gcc
              clang
              
          - name: macosx
            target: torbrowser-osx-x86_64
            components: |
              macosx-toolchain
              clang          
    steps:
      - name: Build Compilers
        uses: mohsen7s/runner-prune-except-docker@main
        with:
          docker-username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker-password: ${{ secrets.DOCKERHUB_PASSWORD }}
          use-image-name: mohsen7s/tbb:sc1
          step-image-name: mohsen7s/tbb:sc1.mat1.${{ matrix.name }}
          run-command: |
            cd tor-browser-build
            ./rbm/rbm build ${{ matrix.components[0] }} --target release --target ${{ matrix.target }}
            ./rbm/rbm build ${{ matrix.components[1] }} --target release --target ${{ matrix.target }}
  

  stage3:
    runs-on: ubuntu-latest
    needs: stage2
    strategy: 
      fail-fast: false    
      matrix:
        include:          
          - name: windows
            target: torbrowser-windows-x86_64
            components: |
              rust
              node
              
          - name: android
            target: torbrowser-android-armv7
            components: |
              rust
              node
              
          - name: linux
            target: torbrowser-linux-x86_64
            components: |
              rust
              node
              
          - name: macosx
            target: torbrowser-osx-x86_64
            components: |
              rust
              node          
    steps:
      - name: Build Rust And Node
        uses: mohsen7s/runner-prune-except-docker@main
        with:
          docker-username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker-password: ${{ secrets.DOCKERHUB_PASSWORD }}
          use-image-name: mohsen7s/tbb:sc1.mat1.${{ matrix.name }}
          step-image-name: mohsen7s/tbb:sc1.mat2.${{ matrix.name }}
          run-command: |
            cd tor-browser-build
            ./rbm/rbm build ${{ matrix.components[0] }} --target release --target ${{ matrix.target }}
            ./rbm/rbm build ${{ matrix.components[1] }} --target release --target ${{ matrix.target }}
  
   
  stage4:
    runs-on: ubuntu-latest
    needs: stage3
    strategy: 
      fail-fast: false    
      matrix:
        include:          
          - name: windows
            target: torbrowser-windows-x86_64
            components: |
              firefox
              
          - name: android
            target: torbrowser-android-armv7
            components: |
              fenix
              
          - name: linux
            target: torbrowser-linux-x86_64
            components: |
              firefox
              
          - name: macosx
            target: torbrowser-osx-x86_64
            components: |
              firefox
              
    steps:
      - name: Build Firefox
        uses: mohsen7s/runner-prune-except-docker@main
        with:
          docker-username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker-password: ${{ secrets.DOCKERHUB_PASSWORD }}
          use-image-name: mohsen7s/tbb:sc1.mat2.${{ matrix.name }}
          step-image-name: mohsen7s/tbb:sc1.mat3.${{ matrix.name }}
          run-command: |
            cd tor-browser-build
            ./rbm/rbm build ${{ matrix.components[0] }} --target release --target ${{ matrix.target }}
  
   
  stage5:
    runs-on: ubuntu-latest
    needs: stage4
    strategy: 
      fail-fast: false
      matrix:
        include:          
          - name: windows
            target: torbrowser-windows-x86_64
            components: |
              release
              
          - name: android
            target: torbrowser-android-armv7
            components: |
              release
              
          - name: linux
            target: torbrowser-linux-x86_64
            components: |
              release
              
          - name: macosx
            target: torbrowser-osx-x86_64
            components: |
              release      
    steps:
      - name: Build Release
        uses: mohsen7s/runner-prune-except-docker@main
        with:
          docker-username: ${{ secrets.DOCKERHUB_USERNAME }}
          docker-password: ${{ secrets.DOCKERHUB_PASSWORD }}
          use-image-name: mohsen7s/tbb:sc1.mat3.${{ matrix.name }}
          step-image-name: mohsen7s/tbb:sc1.mat4.${{ matrix.name }}
          run-command: |
            cd tor-browser-build
            ./rbm/rbm build ${{ matrix.components[0] }} --target release --target ${{ matrix.target }}
  
   
